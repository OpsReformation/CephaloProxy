# Example: Advanced Squid Configuration
# Demonstrates: authentication, cache hierarchy, custom cache sizes, advanced ACLs

# =============================================================================
# Network Configuration
# =============================================================================

# PID file location
pid_filename /var/run/squid/squid.pid

# Primary proxy port
http_port 3128

# Alternative port for authenticated access
# http_port 3129

# =============================================================================
# Cache Configuration
# =============================================================================

# Large cache for high-traffic environments
cache_dir ufs /var/spool/squid 10000 16 256

# Memory cache
cache_mem 512 MB

# Object size limits
maximum_object_size 100 MB
minimum_object_size 0 KB

# Cache replacement policies
cache_replacement_policy heap LFUDA
memory_replacement_policy heap GDSF

# Core dumps directory
coredump_dir /var/cache/squid

# =============================================================================
# Parent Proxy / Cache Hierarchy
# =============================================================================

# Uncomment to use a parent proxy (upstream proxy)
# cache_peer parent.proxy.example.com parent 8080 0 no-query default
# never_direct allow all

# Alternative: sibling peer for cache sharing
# cache_peer sibling.proxy.example.com sibling 3128 3130 proxy-only

# =============================================================================
# Authentication (Basic Auth Example)
# =============================================================================

# Note: Requires additional setup (htpasswd file, ncsa_auth helper)
# Uncomment and configure for authentication:

# auth_param basic program /usr/lib64/squid/basic_ncsa_auth /etc/squid/passwords
# auth_param basic children 5
# auth_param basic realm Squid Proxy
# auth_param basic credentialsttl 2 hours
#
# acl authenticated proxy_auth REQUIRED
# http_access allow authenticated

# =============================================================================
# Advanced Access Control Lists (ACLs)
# =============================================================================

# Standard ACLs
acl SSL_ports port 443
acl Safe_ports port 80 443 21 70 210 1025-65535 280 488 591 777
acl CONNECT method CONNECT

# Network ACLs
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16

# Time-based ACLs
acl business_hours time MTWHF 08:00-18:00
acl weekend time SA 00:00-23:59

# Content type ACLs
acl video_content rep_mime_type video/.*
acl audio_content rep_mime_type audio/.*

# URL pattern ACLs
acl download urlpath_regex -i \.(exe|zip|tar|gz|rar)$
acl streaming url_regex -i youtube\.com/watch netflix\.com

# File size ACL
acl large_files rep_header Content-Length -gt 104857600  # > 100MB

# User agent ACLs (example)
# acl mobile_devices browser -i mobile android iphone

# =============================================================================
# Advanced Access Rules
# =============================================================================

# Deny unsafe ports
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

# Allow localhost management
http_access allow localhost manager
http_access deny manager

# Bandwidth management examples:
# Delay large downloads outside business hours
# delay_pools 1
# delay_class 1 1
# delay_parameters 1 -1/-1  # Unlimited
# delay_access 1 allow large_files !business_hours
# delay_access 1 deny all

# Allow local network access
http_access allow localnet
http_access allow localhost

# Deny all other access
http_access deny all

# =============================================================================
# Logging
# =============================================================================

# Access log with custom format (optional)
# logformat combined %>a %[ui %[un [%tl] "%rm %ru HTTP/%rv" %>Hs %<st "%{Referer}>h" "%{User-Agent}>h" %Ss:%Sh
# access_log stdio:/var/log/squid/access.log combined

# Standard logging
access_log stdio:/var/log/squid/access.log squid
cache_log stdio:/var/log/squid/cache.log

# Debug level
debug_options ALL,1

# Note: log_fqdn is deprecated. Use %>A in log format to log FQDN

# =============================================================================
# Performance Tuning
# =============================================================================

# Connection limits
http_port_max_connections 1000

# Client connection limits
client_lifetime 1 hour
half_closed_clients on

# Refresh patterns
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern -i \.(jpg|jpeg|png|gif|css|js)$ 1440 90% 43200  # Cache images/CSS/JS aggressively
refresh_pattern .               0       20%     4320

# DNS caching
positive_dns_ttl 6 hours
negative_dns_ttl 1 minute

# =============================================================================
# Header Manipulation
# =============================================================================

# Anonymize requests (optional - uncomment to enable)
# request_header_access Referer deny all
# request_header_access X-Forwarded-For deny all
# request_header_access Via deny all
# request_header_access Cache-Control deny all

# Custom headers (optional)
# request_header_add X-Forwarded-Proto https all

# =============================================================================
# Miscellaneous
# =============================================================================

visible_hostname cephaloproxy

# Unique hostname for this proxy instance
# unique_hostname cephaloproxy-01

# Email for error pages
# cache_mgr admin@example.com

# =============================================================================
# Usage Instructions
# =============================================================================
#
# This configuration demonstrates advanced features. Customize as needed:
#
# 1. Authentication:
#    - Create password file: htpasswd -c /etc/squid/passwords username
#    - Mount file: -v /path/to/passwords:/etc/squid/passwords:ro
#    - Uncomment auth_param and authenticated ACL sections
#
# 2. Parent Proxy:
#    - Uncomment cache_peer directive
#    - Replace parent.proxy.example.com with your upstream proxy
#
# 3. Custom Logging:
#    - Uncomment logformat directive for custom log format
#    - Adjust fields as needed
#
# 4. Bandwidth Management:
#    - Uncomment delay_pools configuration
#    - Adjust delay_parameters for desired bandwidth limits
#
# 5. Deploy:
#    docker run -d \
#      --name squid-advanced \
#      -p 3128:3128 -p 8080:8080 \
#      -v /path/to/squid.conf:/etc/squid/squid.conf:ro \
#      -v squid-cache:/var/spool/squid \
#      cephaloproxy:latest
