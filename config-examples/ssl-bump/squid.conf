# Example: Squid Configuration with SSL-Bump (HTTPS Interception)
# SECURITY WARNING: SSL-bump decrypts HTTPS traffic. Only use in controlled
# environments where you have legal authority and user consent.

# =============================================================================
# SSL-Bump Configuration
# =============================================================================

# PID file location
pid_filename /var/run/squid/squid.pid

# Proxy port with SSL-bump enabled
http_port 3128 ssl-bump \
  cert=/etc/squid/ssl_cert/ca.pem \
  key=/etc/squid/ssl_cert/ca.key \
  generate-host-certificates=on \
  dynamic_cert_mem_cache_size=16MB

# SSL certificate helper program (Squid 6.x uses security_file_certgen)
sslcrtd_program /usr/libexec/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 16MB
sslcrtd_children 10 startup=1 idle=1

# =============================================================================
# SSL-Bump Policy
# =============================================================================

# Define SSL bump steps
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

# Peek at step 1 to get SNI
ssl_bump peek step1

# Stare at step 2 to get server certificate
ssl_bump stare step2

# Bump (intercept) at step 3
ssl_bump bump step3

# Alternative: Selective SSL-Bump
# Only bump specific domains, splice (don't intercept) others:
#
# acl bump_domains dstdomain .example.com .company.local
# acl nobump_domains dstdomain .bank.com .healthcare.gov
#
# ssl_bump peek step1
# ssl_bump splice nobump_domains
# ssl_bump stare step2
# ssl_bump bump bump_domains
# ssl_bump splice all

# =============================================================================
# Cache Configuration (Larger for HTTPS content)
# =============================================================================

cache_dir ufs /var/spool/squid 2000 16 256
cache_mem 256 MB
maximum_object_size 20 MB
minimum_object_size 0 KB
cache_replacement_policy heap LFUDA
memory_replacement_policy heap GDSF
coredump_dir /var/cache/squid

# =============================================================================
# Access Control Lists (ACLs)
# =============================================================================

acl SSL_ports port 443
acl Safe_ports port 80 443 21 70 210 1025-65535 280 488 591 777
acl CONNECT method CONNECT

# Local networks
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16

# =============================================================================
# Access Rules
# =============================================================================

http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localnet
http_access allow localhost
http_access deny all

# =============================================================================
# Logging
# =============================================================================

access_log stdio:/var/log/squid/access.log squid
cache_log stdio:/var/log/squid/cache.log
debug_options ALL,1
# Note: log_fqdn is deprecated. Use %>A in log format to log FQDN

# Log SSL bumping decisions (optional, for debugging)
# debug_options 83,5

# =============================================================================
# Performance Tuning
# =============================================================================

refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# =============================================================================
# Miscellaneous
# =============================================================================

visible_hostname cephaloproxy

# =============================================================================
# SSL-Bump Setup Instructions
# =============================================================================
#
# 1. Generate a CA certificate and private key:
#
#    mkdir -p /path/to/ssl-certs
#
#    # Generate CA private key
#    openssl genrsa -out /path/to/ssl-certs/ca.key 4096
#
#    # Generate CA certificate (valid 10 years)
#    openssl req -new -x509 -key /path/to/ssl-certs/ca.key \
#      -out /path/to/ssl-certs/ca.pem -days 3650 \
#      -subj "/C=US/ST=State/L=City/O=Your Organization/CN=Squid Proxy CA"
#
#    # Set secure permissions
#    chmod 640 /path/to/ssl-certs/ca.key
#    chmod 644 /path/to/ssl-certs/ca.pem
#    chown 1000:1000 /path/to/ssl-certs/*
#
# 2. Run container with SSL-bump configuration:
#
#    docker run -d \
#      --name squid-sslbump \
#      -p 3128:3128 -p 8080:8080 \
#      -v /path/to/squid.conf:/etc/squid/squid.conf:ro \
#      -v /path/to/ssl-certs:/etc/squid/ssl_cert:ro \
#      -v squid-cache:/var/spool/squid \
#      cephaloproxy:latest
#
# 3. Trust the CA certificate on client machines:
#
#    # Linux (Ubuntu/Debian)
#    sudo cp /path/to/ssl-certs/ca.pem /usr/local/share/ca-certificates/squid-ca.crt
#    sudo update-ca-certificates
#
#    # macOS
#    sudo security add-trusted-cert -d -r trustRoot \
#      -k /Library/Keychains/System.keychain /path/to/ssl-certs/ca.pem
#
#    # Windows (PowerShell as Administrator)
#    Import-Certificate -FilePath ca.pem -CertStoreLocation Cert:\LocalMachine\Root
#
# 4. Test HTTPS interception:
#
#    export https_proxy=http://localhost:3128
#    curl https://example.com
#
#    # Check logs for SSL bump activity
#    docker logs squid-sslbump | grep -i ssl
#
# IMPORTANT NOTES:
# - SSL-bump is a security-sensitive feature
# - Requires legal authority and user consent
# - CA certificate must be distributed and trusted by all clients
# - Do not use for banking, healthcare, or other sensitive sites without proper authorization
# - Consider using ssl_bump splice for sensitive domains
